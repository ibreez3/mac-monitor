name: Build Mac App

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci

      - name: Build client
        run: npm run build:client

      - name: Install Pillow and create app icon
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install Pillow

          mkdir -p build
          python3 << 'PYSCRIPT'
          from PIL import Image, ImageDraw, ImageFont
          import os
          
          os.chdir('build')
          size = 1024
          img = Image.new('RGBA', (size, size), (74, 144, 226, 255))
          draw = ImageDraw.Draw(img)
          
          try:
            font = ImageFont.truetype('/System/Library/Fonts/Helvetica.ttc', 500)
          except:
            font = ImageFont.load_default()
          
          text = "M"
          bbox = draw.textbbox((0, 0), text, font=font)
          text_width = bbox[2] - bbox[0]
          text_height = bbox[3] - bbox[1]
          
          x = (size - text_width) // 2
          y = (size - text_height) // 2
          
          draw.text((x, y), text, fill=(255, 255, 255, 255), font=font)
          img.save('icon_1024x1024.png')
          print('Created icon')
          PYSCRIPT
          
          # Create iconset
          if [ -f build/icon_1024x1024.png ]; then
            rm -rf build/icon.iconset
            mkdir -p build/icon.iconset
            
            for size in 16 32 128 256 512; do
              sips -z $size $size build/icon_1024x1024.png --out build/icon.iconset/icon_${size}x${size}.png
              sips -z $((size*2)) $((size*2)) build/icon_1024x1024.png --out build/icon.iconset/icon_${size}x${size}@2x.png
            done
            cp build/icon_1024x1024.png build/icon.iconset/icon_512x512@2x.png
            
            iconutil -c icns build/icon.iconset
          fi

      - name: Create entitlements
        run: |
          cat > build/entitlements.mac.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
              <key>com.apple.security.network.client</key>
              <true/>
              <key>com.apple.security.network.server</key>
              <true/>
          </dict>
          </plist>
          PLIST

      - name: Build Electron app
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-monitor-dmg
          path: dist/*.dmg
          retention-days: 30

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-monitor-zip
          path: dist/*.zip
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.dmg
            dist/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
